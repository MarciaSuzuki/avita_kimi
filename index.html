<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AViTA | Sound-Meaning Bridge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Complete CSS included inline */
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c; --bridge: #f39c12; --success: #27ae60; --light: #ecf0f1; --dark: #2c3e50; --border: #bdc3c7; --bg: #f8f9fa; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; height: 100vh; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .app-header { background: white; padding: 12px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--primary); font-size: 1.2rem; }
        .logo i { color: var(--bridge); }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-secondary { background: var(--light); color: var(--dark); border: 1px solid var(--border); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .audio-file-info { font-size: 0.85rem; color: #666; background: var(--light); padding: 4px 12px; border-radius: 20px; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; background: white; border-right: 1px solid var(--border); min-width: 400px; }
        .panel-title { padding: 15px 20px; font-weight: 700; color: var(--primary); border-bottom: 1px solid var(--border); background: #f8f9fa; display: flex; align-items: center; justify-content: space-between; }
        .audio-player { padding: 20px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }
        .play-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--secondary); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .audio-info { flex: 1; }
        .audio-title { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .audio-meta { font-size: 0.85rem; color: #666; font-family: monospace; }
        .speed-control { display: flex; align-items: center; gap: 10px; }
        .speed-btn { background: var(--light); border: 1px solid var(--border); padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .acousteme-container { padding: 20px; flex: 1; overflow-y: auto; background: #f8f9fa; }
        .chunks-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chunks-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .chunk { padding: 10px 12px; background: white; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; min-width: 60px; transition: all 0.2s; }
        .chunk:hover { border-color: var(--secondary); transform: translateY(-2px); }
        .chunk.selected { background: rgba(52, 152, 219, 0.15); border-color: var(--secondary); }
        .chunk.in-range { background: rgba(46, 204, 113, 0.15); border-color: var(--success); }
        .chunk.start-point { border-left: 4px solid var(--success); }
        .chunk.end-point { border-right: 4px solid var(--accent); }
        .chunk-id { font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .chunk-units { font-family: monospace; font-size: 0.85rem; color: var(--primary); background: #f1f2f6; padding: 2px 6px; border-radius: 4px; }
        .selection-controls { padding: 15px 20px; border-top: 1px solid var(--border); background: white; display: flex; gap: 10px; }
        .selection-btn { flex: 1; padding: 10px; border: 2px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .selection-btn.active { border-color: var(--secondary); background: rgba(52, 152, 219, 0.1); color: var(--secondary); }
        .selection-btn.play { background: var(--success); color: white; border-color: var(--success); }
        .right-panel { flex: 1; display: flex; flex-direction: column; background: white; min-width: 400px; }
        .genre-section { padding: 20px; border-bottom: 1px solid var(--border); }
        .genre-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .genre-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .genre-btn { padding: 12px; border: 2px solid var(--border); background: white; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; color: #555; transition: all 0.2s; }
        .genre-btn:hover { border-color: var(--secondary); }
        .genre-btn.selected { background: var(--secondary); color: white; border-color: var(--secondary); }
        .tagging-interface { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tab-header { display: flex; background: #f8f9fa; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab-btn { padding: 15px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #666; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { color: var(--primary); background: rgba(0,0,0,0.03); }
        .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: white; }
        .tab-content { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95rem; }
        .form-select, .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; }
        .checkbox-group, .radio-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid transparent; }
        .intensity-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .intensity-btn { flex: 1; padding: 10px; text-align: center; border: 2px solid var(--border); border-radius: 6px; background: white; cursor: pointer; font-weight: 600; }
        .intensity-btn.selected { background: var(--secondary); color: white; border-color: var(--secondary); }
        .tagged-section { border-top: 1px solid var(--border); padding: 20px; }
        .tagged-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .tagged-items { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .tagged-item { padding: 10px 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--success); display: flex; justify-content: space-between; align-items: center; }
        .tagged-info { flex: 1; }
        .tagged-label { font-weight: 700; color: var(--primary); }
        .tagged-time { font-family: monospace; font-size: 0.8rem; color: #666; }
        .tagged-delete { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; }
        .tagged-delete:hover { color: var(--accent); }
        .mode-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: var(--bridge); color: white; border-radius: 30px; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; }
        .mode-indicator.visible { display: block; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; font-size: 0.95rem; }
        @media (max-width: 1024px) { .main-content { flex-direction: column; } .left-panel, .right-panel { min-width: auto; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo"><i class="fas fa-bridge"></i> AViTA | Sound-Meaning Bridge</div>
            <div class="header-controls">
                <span class="audio-file-info" id="file-info">No file loaded</span>
                <button class="btn btn-secondary" onclick="loadSampleData()"><i class="fas fa-file-audio"></i> Load Sample</button>
                <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
            </div>
        </header>
        <div class="main-content">
            <!-- Left Panel: Acousteme Audio -->
            <div class="left-panel">
                <div class="panel-title"><span><i class="fas fa-wave-square"></i> Acousteme Audio</span><span id="chunk-info">0 chunks</span></div>
                <div class="audio-player">
                    <button class="play-btn" id="play-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                    <div class="audio-info"><div class="audio-title" id="audio-title">Audio Segment</div><div class="audio-meta" id="audio-time">0:00 / 0:00</div></div>
                    <div class="speed-control"><button class="speed-btn" onclick="changeSpeed()" id="speed-btn">1×</button></div>
                </div>
                <div class="acousteme-container">
                    <div class="chunks-header"><div>Tap chunks to select sound segments</div><div class="chunks-controls"><select id="chunk-size" onchange="renderChunks()"><option value="200">Fine</option><option value="400" selected>Medium</option><option value="800">Coarse</option></select></div></div>
                    <div class="chunks-grid" id="chunks-grid"></div>
                </div>
                <div class="selection-controls">
                    <button class="selection-btn" id="btn-start" onclick="setMode('start')"><i class="fas fa-flag"></i> Set Start</button>
                    <button class="selection-btn" id="btn-end" onclick="setMode('end')"><i class="fas fa-flag-checkered"></i> Set End</button>
                    <button class="selection-btn play" onclick="playSelection()" id="btn-play"><i class="fas fa-play"></i> Play Selection</button>
                    <button class="selection-btn" onclick="clearSelection()"><i class="fas fa-times"></i> Clear</button>
                </div>
            </div>
            <!-- Right Panel: Semantic Tagging -->
            <div class="right-panel">
                <div class="genre-section">
                    <div class="genre-title"><i class="fas fa-tags"></i> What type of speech is this?</div>
                    <div class="genre-grid" id="genre-grid"></div>
                </div>
                <div class="tagging-interface">
                    <div class="tab-header" id="tab-header"></div>
                    <div class="tab-content active" id="tab-content"></div>
                </div>
                <div class="tagged-section">
                    <div class="tagged-title"><span><i class="fas fa-tag"></i> Tagged Segments</span><span id="tag-count">0 tagged</span></div>
                    <div class="tagged-items" id="tagged-items"><div class="empty-state">Select acousteme chunks and tag their meaning</div></div>
                </div>
            </div>
        </div>
        <div class="mode-indicator" id="mode-indicator">Tap a chunk to set start point</div>
    </div>
    <audio id="audio-element" style="display: none;"></audio>
    <script>
        // ============ STATE ============
        let currentGenre = null, currentTab = 'events', acoustemeChunks = [], annotations = [];
        let selectionMode = null, startIdx = null, endIdx = null;
        let audioElement = document.getElementById('audio-element');
        let isPlaying = false, playbackSpeed = 1, audioDuration = 30; // Sample audio duration

        // ============ GENRE CONFIG ============
        const genres = [
            { id: 'narrative', name: 'Narrative', icon: 'book' },
            { id: 'poetry', name: 'Poetry/Song', icon: 'music' },
            { id: 'teaching', name: 'Teaching', icon: 'chalkboard-teacher' },
            { id: 'dialogue', name: 'Dialogue', icon: 'comments' },
            { id: 'procedural', name: 'Procedural', icon: 'list-ol' },
            { id: 'descriptive', name: 'Descriptive', icon: 'eye' },
            { id: 'testimony', name: 'Testimony', icon: 'user-check' },
            { id: 'proverb', name: 'Proverb', icon: 'lightbulb' },
            { id: 'prayer', name: 'Prayer', icon: 'pray' },
            { id: 'ceremonial', name: 'Ceremonial', icon: 'place-of-worship' }
        ];

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            initGenres();
            loadSampleData();
            setupAudio();
        });

        function initGenres() {
            const grid = document.getElementById('genre-grid');
            grid.innerHTML = genres.map(g => `<button class="genre-btn" data-genre="${g.id}" onclick="selectGenre('${g.id}')"><i class="fas fa-${g.icon}"></i> ${g.name}</button>`).join('');
        }

        function selectGenre(genreId) {
            currentGenre = genreId;
            document.querySelectorAll('.genre-btn').forEach(b => b.classList.toggle('selected', b.dataset.genre === genreId));
            updateTabsForGenre(genreId);
        }

        function updateTabsForGenre(genreId) {
            let tabs = [];
            if (genreId === 'narrative') tabs = ['events', 'participants', 'emotion', 'discourse'];
            else if (genreId === 'poetry') tabs = ['poetic', 'figurative', 'emotion'];
            else if (genreId === 'teaching') tabs = ['speech', 'terms', 'discourse'];
            else tabs = ['events', 'participants', 'emotion'];
            
            const tabHeader = document.getElementById('tab-header');
            tabHeader.innerHTML = tabs.map(t => `<button class="tab-btn ${t === 'events' ? 'active' : ''}" data-tab="${t}" onclick="selectTab('${t}')">${getTabIcon(t)} ${getTabName(t)}</button>`).join('');
            selectTab(tabs[0]);
        }

        function getTabIcon(tab) { const icons = {events:'bolt',participants:'users',emotion:'heart',discourse:'project-diagram',poetic:'music',figurative:'palette',speech:'comment',terms:'key'}; return `<i class="fas fa-${icons[tab]||'question'}"></i>`; }
        function getTabName(tab) { const names = {events:'Events',participants:'Participants',emotion:'Emotion',discourse:'Discourse',poetic:'Poetic',figurative:'Figurative',speech:'Speech',terms:'Key Terms'}; return names[tab] || tab; }

        function selectTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
            updateTabContent(tabId);
        }

        function updateTabContent(tabId) {
            const content = document.getElementById('tab-content');
            if (tabId === 'events') content.innerHTML = getEventsTab();
            else if (tabId === 'participants') content.innerHTML = getParticipantsTab();
            else if (tabId === 'emotion') content.innerHTML = getEmotionTab();
            else content.innerHTML = `<div class="empty-state">Select genre and tag content</div>`;
        }

        // ============ TAB CONTENT ============
        function getEventsTab() {
            return `<div class="form-group"><label class="form-label">Event Category</label><select class="form-select" id="event-category"><option value="">Select category</option><option>State</option><option>Motion</option><option>Action</option><option>Speech</option></select></div>
                    <div class="form-group"><label class="form-label">Event Core</label><select class="form-select" id="event-core"><option>Select core</option><option>go</option><option>say</option><option>feel</option></select></div>
                    <div class="form-group"><label class="form-label">Initiator</label><input type="text" class="form-input" id="event-initiator" placeholder="Who does it?"></div>
                    <button class="btn btn-primary" onclick="saveEventTag()" style="width:100%;"><i class="fas fa-tag"></i> Tag Event</button>`;
        }

        function getParticipantsTab() {
            return `<div class="form-group"><label class="form-label">Participant Type</label><select class="form-select" id="participant-type"><option>Person</option><option>Group</option><option>Divine</option></select></div>
                    <div class="form-group"><label class="form-label">Participant</label><input type="text" class="form-input" id="participant-ref" placeholder="Name/description"></div>
                    <button class="btn btn-primary" onclick="saveParticipantTag()" style="width:100%;"><i class="fas fa-tag"></i> Tag Participant</button>`;
        }

        function getEmotionTab() {
            return `<div class="form-group"><label class="form-label">Emotion Type</label><select class="form-select" id="emotion-type"><option>Joy</option><option>Sorrow</option><option>Fear</option><option>Anger</option></select></div>
                    <div class="form-group"><label class="form-label">Intensity</label><div class="intensity-buttons"><button class="intensity-btn selected" onclick="selectIntensity('low')">Low</button><button class="intensity-btn" onclick="selectIntensity('medium')">Medium</button><button class="intensity-btn" onclick="selectIntensity('high')">High</button></div></div>
                    <button class="btn btn-primary" onclick="saveEmotionTag()" style="width:100%;"><i class="fas fa-tag"></i> Tag Emotion</button>`;
        }

        // ============ ACOUSTEME FUNCTIONS ============
        function loadSampleData() {
            acoustemeChunks = [];
            for (let i = 0; i < 50; i++) {
                acoustemeChunks.push({
                    id: i,
                    startTime: i * 0.4,
                    endTime: (i + 1) * 0.4,
                    acoustemes: [Math.floor(Math.random() * 100)],
                    isSilence: Math.random() > 0.9
                });
            }
            document.getElementById('file-info').textContent = 'Sample data loaded (50 chunks)';
            document.getElementById('chunk-info').textContent = '50 chunks';
            renderChunks();
        }

        function renderChunks() {
            const grid = document.getElementById('chunks-grid');
            grid.innerHTML = acoustemeChunks.map((chunk, idx) => `
                <div class="chunk ${chunk.isSilence ? 'silence' : ''} ${startIdx === idx ? 'start-point' : ''} ${endIdx === idx ? 'end-point' : ''} ${startIdx !== null && endIdx !== null && idx >= startIdx && idx <= endIdx ? 'in-range' : ''}"
                     onclick="handleChunkClick(${idx})">
                    <div class="chunk-id">#${idx + 1}</div>
                    <div class="chunk-units">${chunk.acoustemes[0]}</div>
                </div>
            `).join('');
        }

        function handleChunkClick(idx) {
            if (selectionMode === 'start') {
                startIdx = idx;
                if (endIdx !== null && endIdx < startIdx) endIdx = null;
                setMode(null);
            } else if (selectionMode === 'end') {
                if (startIdx !== null && idx >= startIdx) endIdx = idx;
                else if (startIdx === null) endIdx = idx;
                setMode(null);
            } else {
                playChunk(idx);
            }
            renderChunks();
            updatePlayButton();
        }

        function setMode(mode) {
            selectionMode = mode;
            document.getElementById('btn-start').classList.toggle('active', mode === 'start');
            document.getElementById('btn-end').classList.toggle('active', mode === 'end');
            const indicator = document.getElementById('mode-indicator');
            if (mode === 'start') {
                indicator.className = 'mode-indicator visible';
                indicator.textContent = 'Tap a chunk to set START point';
            } else if (mode === 'end') {
                indicator.className = 'mode-indicator visible';
                indicator.textContent = 'Tap a chunk to set END point';
            } else {
                indicator.className = 'mode-indicator';
            }
        }

        function clearSelection() {
            startIdx = null;
            endIdx = null;
            selectionMode = null;
            setMode(null);
            renderChunks();
            updatePlayButton();
        }

        function updatePlayButton() {
            const canPlay = startIdx !== null && endIdx !== null;
            document.getElementById('btn-play').disabled = !canPlay;
        }

        // ============ AUDIO PLAYER ============
        function setupAudio() {
            // Create a silent audio buffer for demo
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = 44100;
            const buffer = audioContext.createBuffer(1, sampleRate * audioDuration, sampleRate);
            const channelData = buffer.getChannelData(0);
            for (let i = 0; i < channelData.length; i++) {
                channelData[i] = Math.random() * 0.1; // White noise
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            
            // Simulate audio playback
            audioElement.ontimeupdate = () => {
                document.getElementById('audio-time').textContent = 
                    `${formatTime(audioElement.currentTime)} / ${formatTime(audioDuration)}`;
            };
            audioElement.onended = () => {
                isPlaying = false;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
            };
        }

        function togglePlay() {
            if (isPlaying) {
                audioElement.pause();
                isPlaying = false;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
            } else {
                audioElement.play();
                isPlaying = true;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
            }
        }

        function changeSpeed() {
            const speeds = [1, 0.75, 0.5];
            const idx = speeds.indexOf(playbackSpeed);
            playbackSpeed = speeds[(idx + 1) % speeds.length];
            audioElement.playbackRate = playbackSpeed;
            document.getElementById('speed-btn').textContent = playbackSpeed + '×';
        }

        function playChunk(idx) {
            const chunk = acoustemeChunks[idx];
            // Highlight playing chunk
            document.querySelectorAll('.chunk').forEach(c => c.classList.remove('playing'));
            const chunkEl = document.querySelector(`.chunk:nth-child(${idx + 1})`);
            if (chunkEl) chunkEl.classList.add('playing');
            
            // Simulate playback
            audioElement.currentTime = chunk.startTime;
            audioElement.play();
            isPlaying = true;
            document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
            
            setTimeout(() => {
                if (chunkEl) chunkEl.classList.remove('playing');
            }, (chunk.endTime - chunk.startTime) * 1000);
        }

        function playSelection() {
            if (startIdx === null || endIdx === null) return;
            const startTime = acoustemeChunks[startIdx].startTime;
            const endTime = acoustemeChunks[endIdx].endTime;
            audioElement.currentTime = startTime;
            audioElement.play();
            isPlaying = true;
            document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
            
            // Animate chunks
            for (let i = startIdx; i <= endIdx; i++) {
                setTimeout(() => {
                    const chunkEl = document.querySelector(`.chunk:nth-child(${i + 1})`);
                    if (chunkEl) chunkEl.classList.add('playing');
                }, (acoustemeChunks[i].startTime - startTime) * 1000);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ============ TAGGING FUNCTIONS ============
        function saveEventTag() {
            if (startIdx === null || endIdx === null) {
                alert('Please select acousteme chunks first');
                return;
            }
            
            const category = document.getElementById('event-category').value || 'Unknown';
            const initiator = document.getElementById('event-initiator').value || 'Unspecified';
            
            const annotation = {
                type: 'event',
                genre: currentGenre,
                tab: currentTab,
                category: category,
                initiator: initiator,
                startChunk: startIdx,
                endChunk: endIdx,
                startTime: acoustemeChunks[startIdx].startTime,
                endTime: acoustemeChunks[endIdx].endTime,
                timestamp: new Date().toISOString()
            };
            
            annotations.push(annotation);
            updateTaggedList();
            clearSelection();
        }

        function saveParticipantTag() {
            if (startIdx === null || endIdx === null) {
                alert('Please select acousteme chunks first');
                return;
            }
            
            const participantType = document.getElementById('participant-type').value || 'person';
            const participantRef = document.getElementById('participant-ref').value || 'Unnamed';
            
            const annotation = {
                type: 'participant',
                genre: currentGenre,
                tab: currentTab,
                participantType: participantType,
                reference: participantRef,
                startChunk: startIdx,
                endChunk: endIdx,
                startTime: acoustemeChunks[startIdx].startTime,
                endTime: acoustemeChunks[endIdx].endTime,
                timestamp: new Date().toISOString()
            };
            
            annotations.push(annotation);
            updateTaggedList();
            clearSelection();
        }

        function saveEmotionTag() {
            if (startIdx === null || endIdx === null) {
                alert('Please select acousteme chunks first');
                return;
            }
            
            const emotionType = document.getElementById('emotion-type').value || 'neutral';
            
            const annotation = {
                type: 'emotion',
                genre: currentGenre,
                tab: currentTab,
                emotionType: emotionType,
                startChunk: startIdx,
                endChunk: endIdx,
                startTime: acoustemeChunks[startIdx].startTime,
                endTime: acoustemeChunks[endIdx].endTime,
                timestamp: new Date().toISOString()
            };
            
            annotations.push(annotation);
            updateTaggedList();
            clearSelection();
        }

        function selectIntensity(level) {
            document.querySelectorAll('.intensity-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function updateTaggedList() {
            const container = document.getElementById('tagged-items');
            document.getElementById('tag-count').textContent = `${annotations.length} tagged`;
            
            if (annotations.length === 0) {
                container.innerHTML = '<div class="empty-state">Select acousteme chunks and tag their meaning</div>';
                return;
            }
            
            container.innerHTML = annotations.map((ann, idx) => `
                <div class="tagged-item">
                    <div class="tagged-info">
                        <div class="tagged-label">${ann.type}: ${ann.category || ann.participantType || ann.emotionType || 'tag'}</div>
                        <div class="tagged-time">${formatTime(ann.startTime)} - ${formatTime(ann.endTime)}</div>
                    </div>
                    <button class="tagged-delete" onclick="deleteTag(${idx})">×</button>
                </div>
            `).join('');
        }

        function deleteTag(index) {
            annotations.splice(index, 1);
            updateTaggedList();
        }

        // ============ EXPORT ============
        function exportData() {
            const exportData = {
                metadata: {
                    app: 'AViTA Sound-Meaning Bridge',
                    exportDate: new Date().toISOString(),
                    totalAnnotations: annotations.length
                },
                acoustemeChunks: acoustemeChunks,
                annotations: annotations
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `avita-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${annotations.length} annotations to JSON file`);
        }
    </script>
</body>
</html>
