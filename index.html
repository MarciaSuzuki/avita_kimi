# AViTA | Complete Acousteme Demo with Audio Upload

I'll create a complete version that allows you to upload both an audio file and your acousteme JSON file. Since we can't upload actual audio files here, I'll implement a mock audio player that works with uploaded files.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AViTA | Sound-Meaning Bridge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Complete CSS included inline */
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c; --bridge: #f39c12; --success: #27ae60; --light: #ecf0f1; --dark: #2c3e50; --border: #bdc3c7; --bg: #f8f9fa; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; height: 100vh; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .app-header { background: white; padding: 12px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--primary); font-size: 1.2rem; }
        .logo i { color: var(--bridge); }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-secondary { background: var(--light); color: var(--dark); border: 1px solid var(--border); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .audio-file-info { font-size: 0.85rem; color: #666; background: var(--light); padding: 4px 12px; border-radius: 20px; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; background: white; border-right: 1px solid var(--border); min-width: 400px; }
        .panel-title { padding: 15px 20px; font-weight: 700; color: var(--primary); border-bottom: 1px solid var(--border); background: #f8f9fa; display: flex; align-items: center; justify-content: space-between; }
        .audio-player { padding: 20px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }
        .play-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--secondary); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .audio-info { flex: 1; }
        .audio-title { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .audio-meta { font-size: 0.85rem; color: #666; font-family: monospace; }
        .speed-control { display: flex; align-items: center; gap: 10px; }
        .speed-btn { background: var(--light); border: 1px solid var(--border); padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .acousteme-container { padding: 20px; flex: 1; overflow-y: auto; background: #f8f9fa; }
        .chunks-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chunks-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .chunk { padding: 10px 12px; background: white; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; min-width: 60px; transition: all 0.2s; }
        .chunk:hover { border-color: var(--secondary); transform: translateY(-2px); }
        .chunk.selected { background: rgba(52, 152, 219, 0.15); border-color: var(--secondary); }
        .chunk.in-range { background: rgba(46, 204, 113, 0.15); border-color: var(--success); }
        .chunk.start-point { border-left: 4px solid var(--success); }
        .chunk.end-point { border-right: 4px solid var(--accent); }
        .chunk.playing { background: rgba(52, 152, 219, 0.25); border-color: var(--secondary); }
        .chunk.silence { opacity: 0.5; background: #f1f2f6; }
        .chunk-id { font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .chunk-units { font-family: monospace; font-size: 0.85rem; color: var(--primary); background: #f1f2f6; padding: 2px 6px; border-radius: 4px; }
        .selection-controls { padding: 15px 20px; border-top: 1px solid var(--border); background: white; display: flex; gap: 10px; }
        .selection-btn { flex: 1; padding: 10px; border: 2px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .selection-btn.active { border-color: var(--secondary); background: rgba(52, 152, 219, 0.1); color: var(--secondary); }
        .selection-btn.play { background: var(--success); color: white; border-color: var(--success); }
        .selection-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .right-panel { flex: 1; display: flex; flex-direction: column; background: white; min-width: 400px; }
        .genre-section { padding: 20px; border-bottom: 1px solid var(--border); }
        .genre-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .genre-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .genre-btn { padding: 12px; border: 2px solid var(--border); background: white; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; color: #555; transition: all 0.2s; }
        .genre-btn:hover { border-color: var(--secondary); }
        .genre-btn.selected { background: var(--secondary); color: white; border-color: var(--secondary); }
        .tagging-interface { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tab-header { display: flex; background: #f8f9fa; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab-btn { padding: 15px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #666; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { color: var(--primary); background: rgba(0,0,0,0.03); }
        .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: white; }
        .tab-content { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95rem; }
        .form-select, .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; }
        .checkbox-group, .radio-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid transparent; }
        .intensity-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .intensity-btn { flex: 1; padding: 10px; text-align: center; border: 2px solid var(--border); border-radius: 6px; background: white; cursor: pointer; font-weight: 600; }
        .intensity-btn.selected { background: var(--secondary); color: white; border-color: var(--secondary); }
        .tagged-section { border-top: 1px solid var(--border); padding: 20px; }
        .tagged-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .tagged-items { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .tagged-item { padding: 10px 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--success); display: flex; justify-content: space-between; align-items: center; }
        .tagged-info { flex: 1; }
        .tagged-label { font-weight: 700; color: var(--primary); }
        .tagged-time { font-family: monospace; font-size: 0.8rem; color: #666; }
        .tagged-delete { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; }
        .tagged-delete:hover { color: var(--accent); }
        .mode-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: var(--bridge); color: white; border-radius: 30px; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; z-index: 1000; }
        .mode-indicator.visible { display: block; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; font-size: 0.95rem; }
        .file-upload { padding: 20px; border-bottom: 1px solid var(--border); background: #f8f9fa; }
        .upload-controls { display: flex; gap: 10px; }
        .upload-btn { display: flex; align-items: center; gap: 8px; }
        .waveform-container { padding: 10px 20px; background: #f1f2f6; border-top: 1px solid var(--border); }
        .waveform { height: 60px; background: #2c3e50; border-radius: 4px; position: relative; }
        .progress-bar { position: absolute; top: 0; left: 0; height: 100%; background: rgba(52, 152, 219, 0.5); width: 0%; transition: width 0.1s; }
        .time-marker { position: absolute; top: 0; height: 100%; width: 2px; background: var(--accent); }
        .chunk-highlight { position: absolute; top: 0; height: 100%; background: rgba(46, 204, 113, 0.3); }
        .hidden { display: none; }
        @media (max-width: 1024px) { .main-content { flex-direction: column; } .left-panel, .right-panel { min-width: auto; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo"><i class="fas fa-bridge"></i> AViTA | Sound-Meaning Bridge</div>
            <div class="header-controls">
                <span class="audio-file-info" id="file-info">No files loaded</span>
                <button class="btn btn-secondary" onclick="loadDemoData()"><i class="fas fa-file-audio"></i> Load Demo</button>
                <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
            </div>
        </header>
        <div class="main-content">
            <!-- Left Panel: Acousteme Audio -->
            <div class="left-panel">
                <div class="file-upload">
                    <div class="upload-controls">
                        <label class="btn btn-secondary upload-btn">
                            <i class="fas fa-file-audio"></i> Audio
                            <input type="file" id="audio-upload" accept="audio/*" class="hidden" onchange="loadAudioFile(event)">
                        </label>
                        <label class="btn btn-secondary upload-btn">
                            <i class="fas fa-file-code"></i> Acousteme JSON
                            <input type="file" id="json-upload" accept=".json" class="hidden" onchange="loadJsonFile(event)">
                        </label>
                    </div>
                </div>
                <div class="waveform-container">
                    <div class="waveform" id="waveform">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
                <div class="panel-title"><span><i class="fas fa-wave-square"></i> Acousteme Audio</span><span id="chunk-info">0 chunks</span></div>
                <div class="audio-player">
                    <button class="play-btn" id="play-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                    <div class="audio-info">
                        <div class="audio-title" id="audio-title">No audio loaded</div>
                        <div class="audio-meta" id="audio-time">0:00 / 0:00</div>
                    </div>
                    <div class="speed-control">
                        <button class="speed-btn" onclick="changeSpeed()" id="speed-btn">1×</button>
                    </div>
                </div>
                <div class="acousteme-container">
                    <div class="chunks-header">
                        <div>Tap chunks to select sound segments</div>
                        <div class="chunks-controls">
                            <select id="chunk-size" onchange="renderChunks()">
                                <option value="50">Fine</option>
                                <option value="100" selected>Medium</option>
                                <option value="200">Coarse</option>
                            </select>
                        </div>
                    </div>
                    <div class="chunks-grid" id="chunks-grid"></div>
                </div>
                <div class="selection-controls">
                    <button class="selection-btn" id="btn-start" onclick="setMode('start')"><i class="fas fa-flag"></i> Set Start</button>
                    <button class="selection-btn" id="btn-end" onclick="setMode('end')"><i class="fas fa-flag-checkered"></i> Set End</button>
                    <button class="selection-btn play" onclick="playSelection()" id="btn-play" disabled><i class="fas fa-play"></i> Play Selection</button>
                    <button class="selection-btn" onclick="clearSelection()"><i class="fas fa-times"></i> Clear</button>
                </div>
            </div>
            <!-- Right Panel: Semantic Tagging -->
            <div class="right-panel">
                <div class="genre-section">
                    <div class="genre-title"><i class="fas fa-tags"></i> What type of speech is this?</div>
                    <div class="genre-grid" id="genre-grid"></div>
                </div>
                <div class="tagging-interface">
                    <div class="tab-header" id="tab-header"></div>
                    <div class="tab-content active" id="tab-content"></div>
                </div>
                <div class="tagged-section">
                    <div class="tagged-title"><span><i class="fas fa-tag"></i> Tagged Segments</span><span id="tag-count">0 tagged</span></div>
                    <div class="tagged-items" id="tagged-items">
                        <div class="empty-state">Select acousteme chunks and tag their meaning</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mode-indicator" id="mode-indicator">Tap a chunk to set start point</div>
    </div>
    <audio id="audio-element" style="display: none;"></audio>
    <script>
        // ============ STATE ============
        let currentGenre = null, currentTab = 'events', acoustemeChunks = [], annotations = [];
        let selectionMode = null, startIdx = null, endIdx = null;
        let audioElement = document.getElementById('audio-element');
        let isPlaying = false, playbackSpeed = 1;
        let acoustemeData = null;
        let audioFile = null;
        let audioUrl = null;

        // ============ GENRE CONFIG ============
        const genres = [
            { id: 'narrative', name: 'Narrative', icon: 'book' },
            { id: 'poetry', name: 'Poetry/Song', icon: 'music' },
            { id: 'teaching', name: 'Teaching', icon: 'chalkboard-teacher' },
            { id: 'dialogue', name: 'Dialogue', icon: 'comments' },
            { id: 'procedural', name: 'Procedural', icon: 'list-ol' },
            { id: 'descriptive', name: 'Descriptive', icon: 'eye' },
            { id: 'testimony', name: 'Testimony', icon: 'user-check' },
            { id: 'proverb', name: 'Proverb', icon: 'lightbulb' },
            { id: 'prayer', name: 'Prayer', icon: 'pray' },
            { id: 'ceremonial', name: 'Ceremonial', icon: 'place-of-worship' }
        ];

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            initGenres();
            setupAudioPlayer();
        });

        function initGenres() {
            const grid = document.getElementById('genre-grid');
            grid.innerHTML = genres.map(g => 
                `<button class="genre-btn" data-genre="${g.id}" onclick="selectGenre('${g.id}')">
                    <i class="fas fa-${g.icon}"></i> ${g.name}
                </button>`
            ).join('');
        }

        function selectGenre(genreId) {
            currentGenre = genreId;
            document.querySelectorAll('.genre-btn').forEach(b => 
                b.classList.toggle('selected', b.dataset.genre === genreId));
            updateTabsForGenre(genreId);
        }

        function updateTabsForGenre(genreId) {
            let tabs = [];
            if (genreId === 'narrative') tabs = ['events', 'participants', 'emotion', 'discourse'];
            else if (genreId === 'poetry') tabs = ['poetic', 'figurative', 'emotion'];
            else if (genreId === 'teaching') tabs = ['speech', 'terms', 'discourse'];
            else tabs = ['events', 'participants', 'emotion'];
            
            const tabHeader = document.getElementById('tab-header');
            tabHeader.innerHTML = tabs.map(t => 
                `<button class="tab-btn ${t === 'events' ? 'active' : ''}" data-tab="${t}" onclick="selectTab('${t}')">
                    ${getTabIcon(t)} ${getTabName(t)}
                </button>`
            ).join('');
            selectTab(tabs[0]);
        }

        function getTabIcon(tab) { 
            const icons = {
                events:'bolt', participants:'users', emotion:'heart', 
                discourse:'project-diagram', poetic:'music', figurative:'palette',
                speech:'comment', terms:'key'
            }; 
            return `<i class="fas fa-${icons[tab]||'question'}"></i>`;
        }
        
        function getTabName(tab) { 
            const names = {
                events:'Events', participants:'Participants', emotion:'Emotion',
                discourse:'Discourse', poetic:'Poetic', figurative:'Figurative',
                speech:'Speech', terms:'Key Terms'
            }; 
            return names[tab] || tab; 
        }

        function selectTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(b => 
                b.classList.toggle('active', b.dataset.tab === tabId));
            updateTabContent(tabId);
        }

        function updateTabContent(tabId) {
            const content = document.getElementById('tab-content');
            if (tabId === 'events') content.innerHTML = getEventsTab();
            else if (tabId === 'participants') content.innerHTML = getParticipantsTab();
            else if (tabId === 'emotion') content.innerHTML = getEmotionTab();
            else content.innerHTML = `<div class="empty-state">Select genre and tag content</div>`;
        }

        // ============ FILE UPLOAD ============
        function loadAudioFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            audioFile = file;
            audioUrl = URL.createObjectURL(file);
            audioElement.src = audioUrl;
            
            document.getElementById('audio-title').textContent = file.name;
            document.getElementById('file-info').textContent = `Audio: ${file.name}`;
            
            audioElement.onloadedmetadata = () => {
                updateAudioDisplay();
                drawWaveform();
            };
        }

        function loadJsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    acoustemeData = JSON.parse(e.target.result);
                    processAcoustemeData(acoustemeData);
                    document.getElementById('file-info').textContent = 
                        `${document.getElementById('file-info').textContent}, JSON: ${file.name}`;
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadDemoData() {
            // Use the provided JSON data as demo
            acoustemeData = {
                "duration_sec": 238.6025,
                "num_frames": 11929,
                "segments": [
                    { "start": 0.0, "end": 0.02, "unit_id": 31 },
                    { "start": 0.02, "end": 0.04, "unit_id": 38 },
                    { "start": 0.04, "end": 0.14, "unit_id": 43 }
                    // ... (rest of your JSON data would go here)
                    // For demo, we'll use a subset
                ]
            };
            
            // Create a subset for demo
            acoustemeData.segments = acoustemeData.segments.slice(0, 100);
            processAcoustemeData(acoustemeData);
            
            // Create mock audio
            audioFile = { name: 'demo-audio.wav' };
            audioUrl = '#';
            audioElement.src = '#';
            
            document.getElementById('audio-title').textContent = 'Demo Audio';
            document.getElementById('file-info').textContent = 'Demo audio and acousteme data loaded';
            
            updateAudioDisplay();
            drawWaveform();
        }

        function processAcoustemeData(data) {
            acoustemeChunks = [];
            
            // Group segments into chunks based on time
            const chunkSize = 0.5; // seconds per chunk
            const totalDuration = data.duration_sec;
            const numChunks = Math.ceil(totalDuration / chunkSize);
            
            for (let i = 0; i < numChunks; i++) {
                const chunkStart = i * chunkSize;
                const chunkEnd = (i + 1) * chunkSize;
                
                // Find segments within this chunk
                const segmentsInChunk = data.segments.filter(seg => 
                    seg.end > chunkStart && seg.start < chunkEnd
                );
                
                const unitIds = [...new Set(segmentsInChunk.map(seg => seg.unit_id))];
                
                acoustemeChunks.push({
                    id: i,
                    startTime: chunkStart,
                    endTime: Math.min(chunkEnd, totalDuration),
                    acoustemes: unitIds,
                    isSilence: unitIds.length === 0
                });
            }
            
            document.getElementById('chunk-info').textContent = `${acoustemeChunks.length} chunks`;
            renderChunks();
            updateWaveformChunks();
        }

        // ============ ACOUSTEME FUNCTIONS ============
        function renderChunks() {
            const grid = document.getElementById('chunks-grid');
            const chunkSize = parseInt(document.getElementById('chunk-size').value);
            const displayChunks = Math.ceil(acoustemeChunks.length / (200 / chunkSize));
            
            grid.innerHTML = '';
            
            for (let i = 0; i < Math.min(displayChunks, acoustemeChunks.length); i++) {
                const chunk = acoustemeChunks[i];
                const chunkEl = document.createElement('div');
                chunkEl.className = `chunk ${chunk.isSilence ? 'silence' : ''} 
                    ${startIdx === i ? 'start-point' : ''} 
                    ${endIdx === i ? 'end-point' : ''} 
                    ${startIdx !== null && endIdx !== null && i >= startIdx && i <= endIdx ? 'in-range' : ''}`;
                
                chunkEl.innerHTML = `
                    <div class="chunk-id">#${i + 1}</div>
                    <div class="chunk-units">${chunk.acoustemes.length > 0 ? chunk.acoustemes[0] : '—'}</div>
                `;
                
                chunkEl.onclick = () => handleChunkClick(i);
                grid.appendChild(chunkEl);
            }
        }

        function handleChunkClick(idx) {
            if (selectionMode === 'start') {
                startIdx = idx;
                if (endIdx !== null && endIdx < startIdx) endIdx = null;
                setMode(null);
                highlightWaveformChunk(idx, 'start');
            } else if (selectionMode === 'end') {
                if (startIdx !== null && idx >= startIdx) {
                    endIdx = idx;
                    highlightWaveformChunk(idx, 'end');
                } else if (startIdx === null) {
                    endIdx = idx;
                    highlightWaveformChunk(idx, 'end');
                }
                setMode(null);
            } else {
                playChunk(idx);
            }
            renderChunks();
            updatePlayButton();
        }

        function setMode(mode) {
            selectionMode = mode;
            document.getElementById('btn-start').classList.toggle('active', mode === 'start');
            document.getElementById('btn-end').classList.toggle('active', mode === 'end');
            
            const indicator = document.getElementById('mode-indicator');
            if (mode === 'start') {
                indicator.className = 'mode-indicator visible';
                indicator.textContent = 'Tap a chunk to set START point';
            } else if (mode === 'end') {
                indicator.className = 'mode-indicator visible';
                indicator.textContent = 'Tap a chunk to set END point';
            } else {
                indicator.className = 'mode-indicator';
            }
        }

        function clearSelection() {
            startIdx = null;
            endIdx = null;
            selectionMode = null;
            setMode(null);
            clearWaveformHighlights();
            renderChunks();
            updatePlayButton();
        }

        function updatePlayButton() {
            const canPlay = startIdx !== null && endIdx !== null;
            document.getElementById('btn-play').disabled = !canPlay;
        }

        // ============ AUDIO PLAYER ============
        function setupAudioPlayer() {
            audioElement.ontimeupdate = () => {
                updateProgress();
                updateTimeDisplay();
            };
            
            audioElement.onended = () => {
                isPlaying = false;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
                clearPlayingChunks();
            };
            
            audioElement.onpause = () => {
                isPlaying = false;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
                clearPlayingChunks();
            };
            
            audioElement.onplay = () => {
                isPlaying = true;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
            };
        }

        function updateAudioDisplay() {
            document.getElementById('audio-time').textContent = 
                `0:00 / ${formatTime(audioElement.duration || 0)}`;
        }

        function updateTimeDisplay() {
            const current = audioElement.currentTime || 0;
            const duration = audioElement.duration || 0;
            document.getElementById('audio-time').textContent = 
                `${formatTime(current)} / ${formatTime(duration)}`;
        }

        function updateProgress() {
            const progress = audioElement.currentTime / (audioElement.duration || 1);
            document.getElementById('progress-bar').style.width = `${progress * 100}%`;
            
            // Highlight playing chunk
            const currentChunk = findChunkAtTime(audioElement.currentTime);
            highlightPlayingChunk(currentChunk);
        }

        function findChunkAtTime(time) {
            return acoustemeChunks.findIndex(chunk => 
                time >= chunk.startTime && time < chunk.endTime
            );
        }

        function highlightPlayingChunk(chunkIdx) {
            if (chunkIdx < 0) return;
            
            document.querySelectorAll('.chunk').forEach((el, idx) => {
                el.classList.toggle('playing', idx === chunkIdx);
            });
        }

        function clearPlayingChunks() {
            document.querySelectorAll('.chunk').forEach(el => {
                el.classList.remove('playing');
            });
        }

        function togglePlay() {
            if (audioElement.src === '') {
                alert('Please load an audio file first');
                return;
            }
            
            if (isPlaying) {
                audioElement.pause();
            } else {
                audioElement.play();
            }
        }

        function changeSpeed() {
            const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
            const idx = speeds.indexOf(playbackSpeed);
            playbackSpeed = speeds[(idx + 1) % speeds.length];
            audioElement.playbackRate = playbackSpeed;
            document.getElementById('speed-btn').textContent = playbackSpeed + '×';
        }

        function playChunk(idx) {
            if (audioElement.src === '') {
                alert('Please load an audio file first');
                return;
            }
            
            const chunk = acoustemeChunks[idx];
            audioElement.currentTime = chunk.startTime;
            audioElement.play();
            
            setTimeout(() => {
                if (audioElement.currentTime < chunk.endTime) {
                    audioElement.pause();
                    audioElement.currentTime = chunk.endTime;
                }
            }, (chunk.endTime - chunk.startTime) * 1000);
        }

        function playSelection() {
            if (startIdx === null || endIdx === null || audioElement.src === '') return;
            
            const startTime = acoustemeChunks[startIdx].startTime;
            const endTime = acoustemeChunks[endIdx].endTime;
            
            audioElement.currentTime = startTime;
            audioElement.play();
            
            setTimeout(() => {
                if (audioElement.currentTime < endTime) {
                    audioElement.pause();
                    audioElement.currentTime = endTime;
                }
            }, (endTime - startTime) * 1000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ============ WAVEFORM VISUALIZATION ============
        function drawWaveform() {
            const waveform = document.getElementById('waveform');
            waveform.innerHTML = '<div class="progress-bar" id="progress-bar"></div>';
            
            // Create mock waveform bars for demo
            for (let i = 0; i < 200; i++) {
                const bar = document.createElement('div');
                bar.style.position = 'absolute';
                bar.style.left = `${i * 0.5}%`;
                bar.style.width = '0.4%';
                bar.style.height = `${20 + Math.random() * 80}%`;
                bar.style.top = `${50 - (parseFloat(bar.style.height) / 2)}%`;
                bar.style.backgroundColor = `rgba(52, 152, 219, ${0.3 + Math.random() * 0.5})`;
                bar.style.borderRadius = '1px';
                waveform.appendChild(bar);
            }
        }

        function updateWaveformChunks() {
            const waveform = document.getElementById('waveform');
            // Clear existing chunk highlights
            document.querySelectorAll('.chunk-highlight').forEach(el => el.remove());
            
            // Add chunk markers for first 50 chunks
            for (let i = 0; i < Math.min(50, acoustemeChunks.length); i++) {
                const chunk = acoustemeChunks[i];
                if (chunk.acoustemes.length === 0) continue;
                
                const highlight = document.createElement('div');
                highlight.className = 'chunk-highlight';
                highlight.style.left = `${(chunk.startTime / (audioElement.duration || 238.6)) * 100}%`;
                highlight.style.width = `${((chunk.endTime - chunk.startTime) / (audioElement.duration || 238.6)) * 100}%`;
                highlight.title = `Chunk ${i + 1}: units ${chunk.acoustemes.join(',')}`;
                waveform.appendChild(highlight);
            }
        }

        function highlightWaveformChunk(chunkIdx, type) {
            const chunk = acoustemeChunks[chunkIdx];
            const waveform = document.getElementById('waveform');
            
            // Clear existing markers
            document.querySelectorAll('.time-marker').forEach(el => el.remove());
            
            const marker = document.createElement('div');
            marker.className = 'time-marker';
            marker.style.left = `${(type === 'start' ? chunk.startTime : chunk.endTime) / (audioElement.duration || 238.6) * 100}%`;
            marker.style.backgroundColor = type === 'start' ? 'var(--success)' : 'var(--accent)';
            marker.title = `${type === 'start' ? 'Start' : 'End'} of selection: ${formatTime(type === 'start
